---
title: "Raster_Stack_Rgee_Creation"
author: "Miles Van Denburg"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r}
library(sf)
library(sp)

#remotes::install_github("r-spatial/rgee") Install if you don't have already
library(rgee)

library(tidyverse)
library(reticulate)


# ee_clean_pyenv()
# ee_clean_credentials()
# ee_Initialize()


ee = import("ee")          # Import the Earth Engine library
ee$Initialize() 

np = import("numpy")       # Import Numpy 


py_install("pandas")       #Install Pandas if you don't have it already installed

pd = import("pandas")      # Import Pandas



```


Bring on the RGEE Objects and Vectors
```{r}
# coords_2 <- matrix(c(-71.8215424722187, 42.267434489848135,
#     -71.8215424722187, 42.26733574244465,
#     -71.8213366126768, 42.26733574244465,
#     -71.8213366126768, 42.267434489848135,
#     -71.8215424722187, 42.267434489848135),
#     ncol = 2, byrow = TRUE)
# 
# 
# P1 <- Polygon(coords_2)
# Ps1 <-  SpatialPolygons(list(Polygons(list(P1), ID = "a")), proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
# plot(Ps1, axes = TRUE)
# 
# ps2 <- st_as_sf(Ps1)
# 
# 
# polygon = ee$Geometry$Polygon(
#   list(
#     c(-71.8215424722187, 42.267434489848135),
#     c(-71.8215424722187, 42.26733574244465),
#     c(-71.8213366126768, 42.26733574244465),
#     c(-71.8213366126768, 42.267434489848135),
#     c(-71.8215424722187, 42.267434489848135)
#   )
# )


# Most important for us
eco_mask <- st_read('Ecoregion.shp',quiet = TRUE) %>% st_transform(4326) 

eco_mask_ee <- sf_as_ee(eco_mask)

```


Bring in the imagery from RGEE

```{r}
s3 <- ee$ImageCollection('LANDSAT/LT05/C01/T1_32DAY_EVI')

s3 <-  s3$filterDate(ee$Date('1999-12-01'), ee$Date('2001-01-01'))$filterBounds(eco_mask_ee)


#Show the amount of images in the collection
nbrImages_s3 = s3$size()$getInfo()
nbrImages_s3


#Mapping the clip function over the collection
s3 = s3$map(function(image){image$clip(eco_mask_ee)})

#Selecting the EVI band which holds the information
s3 = s3$select("EVI")

#Get information about the collection 
s3$getInfo()


#get more information on what's stored in the bands
# s3$bandNames()$size()$getInfo()

```



Get setup for the loop.  In case the loop crashes or doesn't work, you must rerun the above chunk first before running this chunk again. 
```{r}
nimages <- s3$size()$getInfo()

ic_date <- ee_get_date_ic(s3)


s2_img_list <- list()
latlng <- list()
lats <- list()
lngs <- list()
evi_values <- list()
s2_names <- list()

for(index in seq_len(nimages)) {
  py_index <- index - 1
  s2_img <- ee$Image(s3$toList(1, py_index)$get(0))
  s2_name <- s2_img$get('system:index')$getInfo()
  s2_img <- s2_img$select("EVI")$rename(s2_name)
  s2_img_list[[index]] <- ee$Image$pixelLonLat()$addBands(s2_img)
  s2_img_list[[index]] <-  s2_img_list[[index]]$reduceRegion(reducer = ee$Reducer$toList(),
                                                        geometry  = eco_mask_ee, 
                                                        maxPixels = 1e6, 
                                                        scale = 10, 
                                                        bestEffort = TRUE)
  lats[[index]] <-  np$array((ee$Array(s2_img_list[[index]]$get("latitude"))$getInfo()))
  lngs[[index]]  <- np$array((ee$Array(s2_img_list[[index]]$get("longitude"))$getInfo()))
  evi_values[[index]] <-  np$array((ee$Array(s2_img_list[[index]]$get(s2_name))$getInfo()))
  
}
```



```{r}
#Create test copy of list to name and evaluate
lats_test <- lats

names(lats_test) <- ic_date$id

#Will evaluate to false sincce the names have change

identical(lats_test[1], lats_test[2])



#Cerate back-up copy to test lat_long equality

lats_test_2 <- lats

identical(lats_test_2[1], lats_test_2[13])


#Cerate back-up copy to test lat_long equality

lngs_test <- lngs

identical(lngs_test[1], lngs_test[13])

names(lngs_test) <- ic_date$id

length(evi_values)

######

#Create copy of evi values and rename the columns of the elements
 evis <- evi_values
names(evis) <- ic_date$id

lats3 <- unlist(lats[1])
lng3 <- unlist(lngs[1])

####

```



Convert list to matrix and create dataframe out of the lats, longs, and evi values


```{r}

evis_df <- data.frame(x = lng3,y = lats3,lapply(evis, "length<-", max(lengths(evis))))

library(raster)
XYZ_2 <- rasterFromXYZ(evis_df, crs = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

```

